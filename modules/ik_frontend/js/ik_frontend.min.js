/*jshint devel:true *//*jshint laxbreak:true*/// Define configuration object to get settings data from backend to frontend.
// Before calls are made to the backend.
var IKFrontend=IKFrontend||{settings:{}},IK=function(){"use strict";function n(e,t,n){this.propreties={};this.__construct(e,t,n)}function r(e){this.token=undefined;this.slides=[];this.updatedSlides=[];this.currentSlide=0;this.timeout=undefined;this.fetched=!1;this.__construct=function(e){this.token=e;this.fetchChannel()};this.fetchChannel=function(){var e=this;f("Trying to fetch channel with token: "+this.token);$.ajax({type:"POST",context:this,url:"/channels/"+this.token+"/update",dataType:"JSON",success:function(e){this.processChannel(e)},error:function(){f("Could not fetch channel from the server with token: "+this.token);e.slides.length!==0?e.nextSlide():alert("There was an error in fetching the channel. Please try agian.")}})};this.processChannel=function(e){f("Channel with token "+this.token+" fetched.");var t=this;t.updatedSlides=[];$.each(e,function(e,r){var i=new n(t.token,r.nid,!0);t.updatedSlides.push(i)});$("body").ajaxStop(function(){if(!this.fetched){this.fetched=!0;f("All slides for the channel ("+t.token+") fechted");if(t.updatedSlides!==0){t.slides=t.updatedSlides.slice(0);t.start()}else alert("Could not fetch all slides. Please try agian.")}else{f("All slides updated for the channel: "+t.token);if(t.updatedSlides!==0){var e=[];$(t.updatedSlides).each(function(){this.get("fetched")&&e.push(this)});e.length!==0&&(t.slides=e.slice(0))}t.nextSlide()}$("body").unbind()})};this.nextSlide=function(){var e=this,t=e.slides[e.currentSlide];t.render();this.timeout=setTimeout(function(){e.currentSlide++;if(e.currentSlide===e.slides.length){e.currentSlide=0;f("Restarting the channel to first slide");e.fetchChannel()}else e.nextSlide()},parseInt(t.get("exposure"),10))};this.start=function(){f("Starting the show");this.nextSlide()};this.stop=function(){f("Stopping the show");clearTimeout(this.timeout)};this.destory=function(){this.stop();this.slides=[];this.fetched=!1;f("Channel have been destroyed.")};this.__construct(e)}function i(e){t===undefined?t=new r(e):t.start()}function s(){t.stop()}function o(t){var r=new n("","",!1);r.processSlide(t);e.animateChange=!0;r.render();this.timeout=setTimeout(function(){r.render()},parseInt(r.get("exposure"),10))}function u(){t.destory()}function a(){e.debug=!e.debug;f("Debug: "+e.debug)}function f(t){e.debug===!0&&console.log(t)}var e={debug:!1,animateChange:!0,fullscreen:!0,orgImgAspect:[1920,1080]},t;n.prototype.__construct=function(e,t,n){this.token=e;this.sid=t;this.directive={".image-container img":{"medium<-media":{"@src":"medium"}},".slide-heading":"title",".slide-subheading":"subheading",".slide-text":"text",".logo-container img@src":"logo",".logo-container@style":function(e){return e.context.logo?"display:block;":"display:none;"}};this.template=$("#pure-template").compile(this.directive);n&&this.fetchSlide()};n.prototype.fetchSlide=function(){var e=this;f("Trying to fetch slide: "+e.sid);$.ajax({type:"POST",url:"/channels/"+e.token+"/slide/"+e.sid,context:this,dataType:"JSON",success:function(e){e.fetched=!0;this.processSlide(e)},error:function(){f("Slide "+e.sid+" fetch failed.");this.propreties.fetched=!1}})};n.prototype.processSlide=function(e){f("Slide "+this.sid+" fetched.");this.propreties=e};n.prototype.get=function(e){if(this.propreties[e]!==undefined)return this.propreties[e];f("Slide failed to get property: "+e);return undefined};n.prototype.startCycle=function(){var e=this;if(e.get("mediacount")>1){var t=1500,n=t*(e.get("mediacount")-1),r=(e.get("exposure")-n)/e.get("mediacount");$(".image-container").cycle({fx:"fade",speed:t,timeout:r,log:!1,loop:1})}};n.prototype.animateChange=function(t,n){var r=this;if(t.length===0){$("#slide-container").html(n);this.startCycle();return}if(e.fullscreen===!0){var i=e.orgImgAspect[0]/e.orgImgAspect[1],s=$(window).width(),o=$(window).height();s/o<i?$(".image-container",n).find("img").height(o):$(".image-container",n).find("img").width(s)}t.css("z-index",2);n.css("z-index",1);$("#slide-container").append(n);t.fadeOut(1500,function(){t.remove();r.startCycle()})};n.prototype.render=function(){var n=$(this.template(this.propreties));n.attr("id","slide-"+this.get("sid"));n.addClass(this.get("layout"));$("#slide-container").removeClass();$("#slide-container").addClass(this.get("color"));if(e.animateChange===!0)this.animateChange($("#slide-container .slide"),n);else{$("#slide-container").html(n);this.startCycle()}$("#progress").stop(!0,!0);$("#progress").css("width","0px");$("#progress").animate({width:"100%"},this.get("exposure"));if(t){var r=t.currentSlide+1,i=t.slides.length;$("#slide-count").text(r+" af "+i);f("Slide amount: "+i+" Current slide: "+r)}f("Slide render: "+this.get("title")+" (exposure: "+this.get("exposure")+")")};return{start:i,stop:s,showSlide:o,destory:u,debug:a}}();